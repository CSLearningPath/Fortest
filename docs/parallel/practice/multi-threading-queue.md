# 概览

多线程共享的队列是多线程编程里的一种相当常见且重要的数据结构。正如我们在[《多线程编程》一节](https://liuhaohua.com/server-programming-guide/parallel/multi-threading/)中看到的那样，需要多线程的场景很多都会表现为一种生产者和消费者之间的协作关系。为了让生产者得以将数据传递给消费者，我们往往就需要一个先进先出（FIFO）的数据结构：队列。

在传统的单线程程序里，实现一个队列相当简单。然而在多线程的环境下，我们的队列必须满足以下额外的条件：

* 线程安全（thread-safe）
  多个线程在并发访问数据结构时，不会出现竞态条件，也不会造成数据结构内部状态的损坏。
* 异常安全（exception-safe）
  当一个线程调用数据结构提供的函数中途出现异常时，数据结构内部状态不会损坏，其他线程依然可以正常访问并得到正确的结果。并且也不会出现内存泄露。

在 C++ 中实现这样的一个队列，至少存在两种方法：基于互斥量的方法和基于原子量的方法。为了简单起见，我们在本节中只介绍基于互斥量的方法。读者可以参考本节的内容自行设计一个基于原子量的队列。

## 分析

C++ 的 STL 中已经提供了一个队列：`std::queue`，虽然它提供了一定的异常安全保证，但它不是线程安全的。


## 小结

在本节中我们

???+info
    对于多线程的生产者和消费者问题，使用队列并不是唯一的答案。对于一些支持 CSP （Communicating sequential processes）范式的语言来说，它们可以使用管道来解决这个问题。例如在 Go 语言中我们可以写出以下的代码：
