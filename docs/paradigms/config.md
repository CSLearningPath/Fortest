# 程序的运行配置

服务器程序通常带有大量的参数需要灵活配置，尽管我们可以通过 `main` 函数的 `argv` 传参，还是稍显麻烦。因此，服务器程序一般需要支持从文件等多种途径读取配置文件启动。另外，我们还需要给不同的配置方法赋予不同的优先级，以便灵活覆盖。通常而言，服务器程序要支持以下几种配置方式（优先级从高到低），优先级高的配置方式，会覆盖掉优先级更低的配置方式的同名参数。

- 命令行传参
- 环境变量配置
- 文件配置
- 远端配置中心拉取
- 写死在程序中的默认值

其中，命令行传参一般用于在调试的时候快速覆盖某些参数而不必修改配置文件。

环境变量同样用于快速覆盖某些参数，但可以避免冗长的命令行参数，另外，通过环境变量配置程序也是容器化部署服务时常用的配置方法。

文件配置通常用于程序正式上线后稳定的程序配置。一般需要支持在多个目录中搜索配置文件，不同目录同样具有优先级，不同的是，配置文件一般只会读取优先级最高的那个文件。使用文件的好处一个是方便查看和修改，另一方面程序可以在运行的时候检测配置文件的变化，这样修改配置文件后不需要重新启动程序就能使新的配置生效，使得配置修改对线上服务影响最小。一般来说搜索配置目录的优先级从高到低是：

- 命令行指定的配置文件
- 命令行参数指定的多个搜索目录
- 当前程序运行的目录
- 每个用户独立的配置目录（例如 $HOME/.myserver/config）
- 系统级别的配置目录（例如 /etc/myserver/config）

远端配置中心拉取则是在分布式系统中，由统一的配置中心服务负责下发配置，保证每个服务器程序使用的都是相同的配置。和文件配置一样，我们的程序可以监听配置中心配置的变化，或者由配置中心主动下发新配置，实现配置的重载。另外，除了服务器程序自己拉取以外，还有一种方式是使用独立的程序负责下载配置，然后写入到服务器程序配置文件的搜索目录里，这样可以更好地解耦。

为了方便使用，一般还会在编译时，就把一些参数编译到程序中作为最后的默认值。这些参数通常会以宏定义或常量方式写在程序里，用宏定义的参数可以很方便的在编译的时候覆盖新的值。